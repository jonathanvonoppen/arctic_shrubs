---
title: 'Nuuk Fjord: Drivers of shrub abundance - exploratory plots'
author: "Jonathan von Oppen"
date: "13/05/2020"
output:
  html_notebook:
    code_folding: hide
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
## Dependencies
Packages included:

* tidyverse - for convenient code flow, data wrangling and plotting
* rjags & R2jags - to link JAGS and R
* skimr - for data summary
* Rmarkdown - to produce this neat little documentation
```{r, message = FALSE}
# load pacman package from the repository, if you do not already have it
if (!require('pacman')) install.packages('pacman', repos="https://cloud.r-project.org")
pacman::p_load(tidyverse, # set of packages for data manipulation, exploration and visualisation
               rjags,     # to link JAGS and R
               R2jags,    # to link JAGS and R
               skimr,     # for quick dataframe inspection
               rmarkdown) # for R Markdown formatting
```

## Import data
Analyses conducted on fusion table at **plot group $\times$ taxon level**: 621 observations for 57 variables
```{r}
env_cov_bio <- read.csv("../data/nuuk_env_cover_plotgroups.csv", header = T)
```
<button class="btn btn-primary" data-toggle="collapse" data-target="#BlockName"> Show/Hide Data Summary </button>
<div id="BlockName" class="collapse">
```{r}
skim(env_cov_bio)
```

## Selection of variables relevant for analysis
including predictors

* Information on site, plot group, sampling location (lat, lon, altitude), sampling year 
* downscaled CHELSA predictors (*[...]_ts_XX*) 
* solar radiation index (SRI, following [Keating et al. 2007](http://www.bioone.org/doi/abs/10.2193/2006-359), yet to come), slope (erosion measure) & moisture availability (-> Jakob, yet to come)
* taxon (see above for levels)
* competition pressure in the community (as summed abundance of taller-growing shrub species within a plot, averaged within plot groups)

and response variable 

* cover (as relative no. hits per plot, averaged within plot groups)
```{r}
env_cov_bio_sub <- env_cov_bio %>% 
  select(site_alt_plotgroup_id, site, site_alt_id, year, long, lat,  # plot info / metadata
  ends_with("_ts_10"),   # CHELSA predictors averaged over 10-year period prior to study year
  inclin_down, twi_90m, #sri, 
  #mean_summ_ndvi_yos, cv_mean_summ_ndvi_2001_to_yos, Perc_dist_coast_lines,   # environmental data
  taxon, cover, compet)   # taxon, cover response, competition pressure
head(env_cov_bio_sub)
```

### Make exploratory plots for relationships between predictors and cover

Let's create some plots to show possible effects of predictor variables on cover for the different species:

```{r, message = FALSE}
env_cov_bio.long <- env_cov_bio %>% 
  select(taxon,
         inclin_down,
         ends_with("ts_30"),
         twi_90m,
         compet,
         cover) %>% 
  # pivot to long format
  pivot_longer(cols = c(inclin_down,
                           ends_with("ts_30"),
                           twi_90m,
                           compet),
               names_to = "predictor",
               values_to = "pred_value")

# build function
pred.plot.grid <- function(df){
  
  taxa <- df %>% pull(taxon) %>% unique() %>% as.character()
  
  for(taxon_nr in 1:length(taxa)){
    plot <- ggplot(data = df %>% filter(taxon == taxa[taxon_nr]), 
                   aes(y = cover, group = taxon)) +
      geom_point(aes(x = pred_value), colour = "darkgrey") +
      geom_smooth(aes(x = pred_value), method = "lm", colour = "black", se = TRUE, na.rm = TRUE) +
      facet_wrap(~predictor, scales = "free", ncol = 3) +
      scale_y_continuous("relative no. pin hits per plot group",
                         limits = c(0, max(df %>% 
                                             filter(taxon == taxa[taxon_nr]) %>% 
                                             pull(cover)))) +
      labs(x = "predictor value") +
      ggtitle(paste0(taxa[taxon_nr], " cover ~ predictors")) +
      theme_bw() +
      theme(legend.position = "none")
    print(plot)
  }
}

# run
pred.plot.grid(env_cov_bio.long)
```