---
title: "Nuuk Fjord: Drivers of shrub abundance - development of beta-binomial mixture model"
author: "Jonathan von Oppen"
date: "07/04/2020"
output: 
html_notebook: default
code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Dependencies ####
Packages included:
* tidyverse - for convenient code flow, data wrangling and plotting
* rjags & R2jags - to link JAGS and R
```{r, message = FALSE}
# load pacman package from the repository, if you do not already have it
if (!require('pacman')) install.packages('pacman', repos="https://cloud.r-project.org")
pacman::p_load(tidyverse, # set of packages for data manipulation, exploration and visualisation
               rjags,     # to link JAGS and R
               R2jags,    # to link JAGS and R
               rmarkdown, 
               knitr)     # for R Markdown formatting
```
# Import data ####
Analyses conducted on fusion table at **plot group $\times$ taxon level**
```{r}
env_cov_bio <- read.csv(file.path(getwd(), "data", "Nuuk_fusion_table_plotgroupXtaxon_level.csv"), header = T)
head(env_cov_bio)
```
Only taxa with competition data included, i.e.
```{r}
tibble(levels(env_cov_bio$taxon))
```
# Prepare data for JAGS model ####
## Selection of variables relevant for analysis
including predictors
* Information on site, plot group, sampling location (lat, lon, altitude), sampling date
* elevation-adjusted WorldClim predictors (*bio_X_rect*)
* solar radiation index (SRI, following [XX et al. ]), slope (erosion measure) & moisture availability (Jakob, yet to come)
* year-of-sampling & long-term (=2001-yos average) NDVI
* continentality as percent distance from coast lines
* taxon (see above for levels)
* competition pressure in the community (as summed abundance of taller-growing shrub species within a plot, averaged within plot groups)
and response variable 
* cover (as relative no. hits per plot, averaged within plot groups)
```{r}
env_cov_bio_sub <- env_cov_bio %>% select(plot.group.name, site, date, year, long, lat, location,   # plot info / metadata
                              starts_with("bio_"),   # WorldClim predictors
                              wc_alt, ddeg, sri, mean_summ_ndvi_yos, cv_mean_summ_ndvi_2001_to_yos, Perc_dist_coast_lines,   # environmental data
                              taxon, cover, compet)   # taxon, cover response, competition pressure
head(env_cov_bio_sub)
```

## Abundance check & selection of taxa
Some of the target taxa show low abundance for most of the plot groups:
```{r}
# Summary of zeros per taxon & as percentage of all 69 plotgroups:
env_cov_bio %>% group_by(taxon) %>% summarise_at(vars(cover), list(~sum(. == 0))) %>% rename(zeros = cover) %>% mutate(zeros_perc = zeros/69) %>% arrange(desc(zeros))
```

To ensure model convergence, we remove *Cassiope tetragona* & *Phyllodoce coerulea* (moving down the list):
```{r}
env_cov_bio_sub <- env_cov_bio_sub[env_cov_bio_sub$taxon %in% c("Cassiope tetragona", "Phyllodoce coerulea")==F,] %>% 
  droplevels(env_cov_bio_sub$taxon)
head(env_cov_bio_sub, nlevels(env_cov_bio_sub$taxon))
```
**!!! Model crashes if >2 taxa removed !!!** (JvO 06 Apr 20)

